name: "advanced_json_task"
description: "Comprehensive JSON data generation showcasing advanced features"
steps:
  - name: "customer_accounts" 
    type: "json"
    options:
      path: "/opt/app/data/customer/account_json"
      saveMode: "overwrite"
    count:
      records: 1000
    fields:
      - name: "account_id"
        type: "string"
        options:
          regex: "ACC[0-9]{8}"
          isUnique: true
      - name: "balance"
        type: "decimal(5,2)"
        options:
          min: 0.01
          max: 10000.00
      - name: "created_by"
        type: "string" 
        options:
          expression: "#{Name.name}"
      - name: "created_by_fixed_length"
        type: "string"
        options:
          sql: "CASE WHEN status IN ('open', 'closed') THEN 'eod' ELSE 'event' END"
      - name: "open_time"
        type: "timestamp"
        options:
          min: "2022-01-01 00:00:00"
          max: "2023-12-31 23:59:59"
      - name: "status"
        type: "string"
        options:
          oneOf: ["open", "closed", "suspended", "pending"]
      - name: "year"
        type: "integer"
        options:
          sql: "YEAR(open_time)"
      - name: "customer_details"
        type: "struct"
        fields:
          - name: "name"
            type: "string"
            options:
              expression: "#{Name.name}"
          - name: "age"
            type: "integer"
            options:
              min: 18
              max: 90
          - name: "city"
            type: "string"
            options:
              expression: "#{Address.city}"
          - name: "email_domain"
            type: "string"
            options:
              sql: "SUBSTRING_INDEX(customer_details.email, '@', -1)"
          - name: "email"
            type: "string"
            options:
              expression: "#{Internet.emailAddress}"
      - name: "transaction_history"
        type: "array<struct<txn_date: date, amount: double, merchant: string>>"
        options:
          arrayMinLength: 1
          arrayMaxLength: 10
        fields:
          - name: "txn_date"
            type: "date"
            options:
              min: "2022-01-01"
              max: "2023-12-31"
          - name: "amount"
            type: "double"
            options:
              min: 5.0
              max: 500.0
          - name: "merchant"
            type: "string"
            options:
              expression: "#{Company.name}"
      - name: "first_transaction_date"
        type: "date"
        options:
          sql: "element_at(sort_array(transaction_history.txn_date), 1)"
      - name: "total_transaction_amount"
        type: "double"
        options:
          sql: "aggregate(transaction_history.amount, 0.0, (acc, x) -> acc + x)"
      - name: "account_display_name"
        type: "string"
        options:
          sql: "CONCAT(customer_details.name, ' - ', status, ' (', account_id, ')')"
    validations:
      - field: "account_id"
        isNull: false
        description: "Account ID should never be null"
      - field: "balance" 
        greaterThan: 0
        description: "Balance should be positive"
      - expr: "year >= 2022"
        description: "Year should be 2022 or later"
      - unique: ["account_id"]
        description: "Account ID should be unique"